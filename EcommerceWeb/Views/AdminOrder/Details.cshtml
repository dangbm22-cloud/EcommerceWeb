@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Chi tiết đơn hàng";
}

@model EcommerceWeb.Models.Order

<div class="container mt-4">
    <h2>Chi tiết đơn hàng #@Model.Id</h2>
    <p><strong>Khách hàng:</strong> @Model.FullName</p>
    <p><strong>Email:</strong> @Model.Email</p>
    <p><strong>Địa chỉ:</strong> @Model.Address, @Model.City</p>
    <p><strong>Trạng thái:</strong> @EcommerceWeb.Helpers.OrderStatusHelper.GetAdminStatus(Model.Status)</p>

    @if (Model.Status != "Completed"
        && Model.Status != "CancelledByAdmin"
        && Model.Status != "CancelledByCustomer")
    {
        <div class="mt-3">
            <!-- Nút cập nhật sang Shipped: chỉ hiện khi Pending -->
            @if (Model.Status == "Pending")
            {
                <button type="button" class="btn btn-warning" onclick="confirmUpdate('@Model.Id', 'Shipped')">
                    Đánh dấu: Đã giao cho đơn vị vận chuyển
                </button>

                <!-- Nút hủy đơn: chỉ hiện khi Pending -->
                <button type="button" class="btn btn-danger" onclick="confirmUpdate('@Model.Id', 'CancelledByAdmin')">
                    Hủy đơn hàng
                </button>
            }

            <!-- Nếu đã Shipped thì không hiện nút hủy nữa -->
            @if (Model.Status == "Shipped")
            {
                <p class="text-muted"><em>Đơn hàng đã giao cho đơn vị vận chuyển, không thể hủy nữa.</em></p>
            }
        </div>
    }
    else
    {
        <p class="text-muted mt-3"><em>Đơn hàng đã kết thúc, không thể cập nhật trạng thái nữa.</em></p>
    }

    <h4 class="mt-4">Sản phẩm trong đơn</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Sản phẩm</th>
                <th>Giá</th>
                <th>Số lượng</th>
                <th>Tổng</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Details)
            {
                <tr>
                    <td>@item.ProductName</td>
                    <td>@string.Format("{0:N0}", item.UnitPrice) VND</td>
                    <td>@item.Quantity</td>
                    <td>@string.Format("{0:N0}", item.UnitPrice * item.Quantity) VND</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        function confirmUpdate(orderId, status) {
            let message = "";
            if (status === "Shipped") {
                message = "Bạn có muốn cập nhật trạng thái đơn hàng không?";
            } else if (status === "CancelledByAdmin") {
                message = "Bạn có chắc chắn muốn hủy đơn hàng này?";
            }

            if (confirm(message)) {
                // Gửi form ẩn để cập nhật
                const form = document.createElement("form");
                form.method = "post";
                form.action = "/AdminOrder/UpdateStatus";

                const idInput = document.createElement("input");
                idInput.type = "hidden";
                idInput.name = "id";
                idInput.value = orderId;
                form.appendChild(idInput);

                const statusInput = document.createElement("input");
                statusInput.type = "hidden";
                statusInput.name = "status";
                statusInput.value = status;
                form.appendChild(statusInput);

                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}
